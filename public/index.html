<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simon Says IoT - Interactive Game Interface</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Animated Background -->
    <div class="background-animation">
        <div class="floating-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
            <div class="shape shape-4"></div>
            <div class="shape shape-5"></div>
            <div class="shape shape-6"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-decoration">
                    <div class="deco-line"></div>
                    <i class="fas fa-microchip header-icon"></i>
                    <div class="deco-line"></div>
                </div>
                <h1 class="title">
                    <span class="game-title">
                        <span class="title-accent">Simon Says</span>
                        <span class="title-main">IoT</span>
                    </span>
                    <span class="subtitle">
                        <i class="fas fa-wifi"></i>
                        Hardware Interactive Game
                        <i class="fas fa-gamepad"></i>
                    </span>
                </h1>
                <div class="header-stats">
                    <div class="stat-item">
                        <i class="fas fa-signal"></i>
                        <span id="connection-status">Checking Connection...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Game Control Panel -->
            <section class="game-panel">
                <div class="panel-header">
                    <h2>
                        <i class="fas fa-play-circle"></i>
                        Game Control Panel
                    </h2>
                    <div class="panel-status">
                        <div class="status-indicator">
                            <div class="status-dot" id="gameStatusDot"></div>
                            <span id="gameStatusText">Ready to Play</span>
                        </div>
                    </div>
                </div>

                <div class="game-controls">
                    <div class="input-section">
                        <div class="input-group">
                            <label for="playerName" class="input-label">
                                <i class="fas fa-user"></i>
                                Player Name
                            </label>
                            <input type="text" id="playerName" class="name-input" 
                                   placeholder="Enter your name..." maxlength="20" autocomplete="off">
                            <div class="input-underline"></div>
                        </div>
                        <button id="startBtn" class="start-btn" onclick="startGame()">
                            <span class="btn-content">
                                <i class="fas fa-rocket" id="btnIcon"></i>
                                <span id="btnText">Start Game</span>
                            </span>
                            <div class="btn-glow"></div>
                        </button>
                    </div>

                    <div class="game-instructions">
                        <h3><i class="fas fa-info-circle"></i> How to Play</h3>
                        <div class="instruction-grid">
                            <div class="instruction-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h4>Enter Your Name</h4>
                                    <p>Type your name in the input field above</p>
                                </div>
                            </div>
                            <div class="instruction-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h4>Start the Game</h4>
                                    <p>Click "Start Game" to begin the challenge</p>
                                </div>
                            </div>
                            <div class="instruction-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h4>Watch the LEDs</h4>
                                    <p>Pay attention to the LED sequence on the hardware</p>
                                </div>
                            </div>
                            <div class="instruction-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h4>Repeat the Pattern</h4>
                                    <p>Press the buttons in the exact same order</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Hardware Status Panel -->
            <section class="hardware-panel">
                <div class="panel-header">
                    <h2>
                        <i class="fas fa-microchip"></i>
                        Hardware Status
                    </h2>
                </div>
                <div class="hardware-grid">
                    <div class="hardware-card">
                        <div class="card-icon">
                            <i class="fas fa-wifi"></i>
                        </div>
                        <div class="card-content">
                            <h3>ESP8266 Board</h3>
                            <div class="status-row">
                                <div class="status-dot" id="hardwareStatusDot"></div>
                                <span id="hardwareStatusText">Checking...</span>
                            </div>
                        </div>
                        <div class="card-decoration"></div>
                    </div>
                    <div class="hardware-card">
                        <div class="card-icon">
                            <i class="fas fa-server"></i>
                        </div>
                        <div class="card-content">
                            <h3>Azure Server</h3>
                            <div class="status-row">
                                <div class="status-dot" id="serverStatusDot"></div>
                                <span id="serverStatusText">Online</span>
                            </div>
                        </div>
                        <div class="card-decoration"></div>
                    </div>
                    <div class="hardware-card">
                        <div class="card-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="card-content">
                            <h3>LED Display</h3>
                            <div class="status-row">
                                <div class="status-dot online"></div>
                                <span>1 Second Visibility</span>
                            </div>
                        </div>
                        <div class="card-decoration"></div>
                    </div>
                    <div class="hardware-card">
                        <div class="card-icon">
                            <i class="fas fa-hand-pointer"></i>
                        </div>
                        <div class="card-content">
                            <h3>Button Input</h3>
                            <div class="status-row">
                                <div class="status-dot online"></div>
                                <span>Ultra Responsive</span>
                            </div>
                        </div>
                        <div class="card-decoration"></div>
                    </div>
                </div>
            </section>

            <!-- Recent Games Panel -->
            <section class="recent-games-panel">
                <div class="panel-header">
                    <h2>
                        <i class="fas fa-clock"></i>
                        Recent Games
                    </h2>
                    <div class="panel-actions">
                        <button class="action-btn" onclick="loadRecentGames()">
                            <i class="fas fa-refresh"></i>
                        </button>
                    </div>
                </div>
                <div class="recent-games-content" id="recentGames">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-gamepad"></i>
                        </div>
                        <h3>No Recent Games</h3>
                        <p>Start your first game to see recent activity here!</p>
                    </div>
                </div>
            </section>

            <!-- Statistics Panel -->
            <section class="stats-panel">
                <div class="panel-header">
                    <h2>
                        <i class="fas fa-chart-line"></i>
                        Live Statistics
                    </h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-games">0</div>
                            <div class="stat-label">Total Games</div>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="highest-score">0</div>
                            <div class="stat-label">Highest Score</div>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-crown"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="average-score">0</div>
                            <div class="stat-label">Average Score</div>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="active-players">0</div>
                            <div class="stat-label">Active Players</div>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-user-friends"></i>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Leaderboard Panel -->
            <section class="leaderboard-panel">
                <div class="panel-header">
                    <h2>
                        <i class="fas fa-medal"></i>
                        Leaderboard
                    </h2>
                    <div class="panel-actions">
                        <div class="refresh-timer">
                            <i class="fas fa-sync-alt"></i>
                            <span id="refresh-timer">Auto-refresh in 10s</span>
                        </div>
                        <button class="action-btn" onclick="loadLeaderboard()">
                            <i class="fas fa-refresh"></i>
                        </button>
                    </div>
                </div>

                <div class="leaderboard-content">
                    <div class="table-container">
                        <table class="leaderboard-table" id="leaderboard-table">
                            <thead>
                                <tr>
                                    <th class="rank-col">
                                        <i class="fas fa-hashtag"></i>
                                        Rank
                                    </th>
                                    <th class="name-col">
                                        <i class="fas fa-user"></i>
                                        Player
                                    </th>
                                    <th class="score-col">
                                        <i class="fas fa-star"></i>
                                        Score
                                    </th>
                                    <th class="time-col">
                                        <i class="fas fa-clock"></i>
                                        Time
                                    </th>
                                    <th class="network-col">
                                        <i class="fas fa-wifi"></i>
                                        Network
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-tbody">
                                <!-- Data will be loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="empty-state" id="empty-state" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h3>No Scores Yet</h3>
                        <p>Be the first to play Simon Says and claim the top spot!</p>
                        <button class="cta-btn" onclick="document.getElementById('playerName').focus()">
                            <i class="fas fa-play"></i>
                            Start Playing
                        </button>
                    </div>

                    <div class="error-state" id="error-state" style="display: none;">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Connection Error</h3>
                        <p id="error-message">Unable to load leaderboard data.</p>
                        <button class="retry-btn" onclick="loadLeaderboard()">
                            <i class="fas fa-redo"></i>
                            Try Again
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Simon Says IoT</h4>
                    <p>Hardware Interactive Game</p>
                </div>
                <div class="footer-section">
                    <h4>Server Info</h4>
                    <p>
                        <i class="fas fa-server"></i>
                        <code>Azure Cloud Service</code>
                    </p>
                </div>
                <div class="footer-section">
                    <h4>Hardware Status</h4>
                    <p>
                        <i class="fas fa-microchip"></i>
                        ESP8266: <span id="esp8266-status">Checking...</span>
                    </p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Simon Says IoT - Enhanced Interactive Experience</p>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables
        let refreshInterval;
        let nextRefreshTime = 10;
        let gameCheckInterval;
        let recentGamesData = [];

        // Game state
        let currentGame = {
            isActive: false,
            playerName: '',
            startTime: null
        };

        // Enhanced UI animations
        function initializeAnimations() {
            // Add entrance animations
            const elements = document.querySelectorAll('.game-panel, .hardware-panel, .recent-games-panel, .stats-panel, .leaderboard-panel');
            elements.forEach((element, index) => {
                element.style.animationDelay = `${index * 0.1}s`;
                element.classList.add('fade-in-up');
            });
        }

        // Enhanced start game function
        async function startGame() {
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!playerName) {
                showNotification('Please enter your name first!', 'warning');
                document.getElementById('playerName').focus();
                return;
            }
            
            if (playerName.length < 2) {
                showNotification('Name must be at least 2 characters long!', 'warning');
                return;
            }
            
            const startBtn = document.getElementById('startBtn');
            const btnText = document.getElementById('btnText');
            const btnIcon = document.getElementById('btnIcon');
            
            try {
                // Show loading state
                startBtn.disabled = true;
                startBtn.classList.add('loading');
                btnIcon.className = 'fas fa-spinner fa-spin';
                btnText.textContent = 'Starting Game...';
                
                // Send start game request
                const response = await fetch('/start-game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerName })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to start game');
                }
                
                const result = await response.json();
                
                // Update UI to active state
                updateGameStatus('active', `Game started for ${playerName}! Watch the hardware...`);
                btnIcon.className = 'fas fa-gamepad';
                btnText.textContent = 'Game Active';
                startBtn.classList.remove('loading');
                startBtn.classList.add('active');
                
                // Set current game
                currentGame = {
                    isActive: true,
                    playerName: playerName,
                    startTime: new Date()
                };
                
                // Show success notification
                showNotification(`Game started for ${playerName}! Good luck! 🎮`, 'success');
                
                // Start monitoring
                startGameMonitoring();
                
            } catch (error) {
                console.error('Error starting game:', error);
                showNotification('Failed to start game. Please try again!', 'error');
                
                // Reset button
                startBtn.disabled = false;
                startBtn.classList.remove('loading');
                btnIcon.className = 'fas fa-rocket';
                btnText.textContent = 'Start Game';
            }
        }

        // Enhanced game monitoring with faster polling
        function startGameMonitoring() {
            if (gameCheckInterval) {
                clearInterval(gameCheckInterval);
            }
            
            // Faster polling for more responsive game state detection
            gameCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/game-status');
                    const status = await response.json();
                    
                    if (!status.isGameActive && currentGame.isActive) {
                        gameFinished();
                    }
                } catch (error) {
                    console.error('Error checking game status:', error);
                    // Auto-retry after connection error
                    setTimeout(() => {
                        if (currentGame.isActive) {
                            console.log('Retrying game status check...');
                        }
                    }, 2000);
                }
            }, 2000); // Reduced from 5000ms to 2000ms for faster response
        }

        // Enhanced game finished function
        function gameFinished() {
            currentGame.isActive = false;
            
            const startBtn = document.getElementById('startBtn');
            const btnText = document.getElementById('btnText');
            const btnIcon = document.getElementById('btnIcon');
            
            // Reset button
            startBtn.disabled = false;
            startBtn.classList.remove('active');
            btnIcon.className = 'fas fa-rocket';
            btnText.textContent = 'Start Game';
            
            updateGameStatus('online', 'Game completed! Ready for next player.');
            
            // Clear input and show notification
            document.getElementById('playerName').value = '';
            showNotification('Game completed! Check your score in the leaderboard! 🏆', 'info');
            
            // Stop monitoring
            if (gameCheckInterval) {
                clearInterval(gameCheckInterval);
            }
            
            // Refresh data
            setTimeout(() => {
                loadLeaderboard();
                loadRecentGames();
            }, 2000);
        }

        // Enhanced status update function
        function updateGameStatus(status, message) {
            const statusDot = document.getElementById('gameStatusDot');
            const statusText = document.getElementById('gameStatusText');
            
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = message;
            
            // Add pulse animation for active status
            if (status === 'active') {
                statusDot.classList.add('pulse');
            } else {
                statusDot.classList.remove('pulse');
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notif => notif.remove());
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <i class="${icons[type]}"></i>
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Enhanced recent games loading
        async function loadRecentGames() {
            try {
                const response = await fetch('/api/leaderboard?limit=5');
                const data = await response.json();
                
                const recentGamesDiv = document.getElementById('recentGames');
                
                if (data.length === 0) {
                    recentGamesDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-gamepad"></i>
                            </div>
                            <h3>No Recent Games</h3>
                            <p>Start your first game to see recent activity here!</p>
                        </div>
                    `;
                    return;
                }
                
                recentGamesData = data.slice(0, 5);
                
                recentGamesDiv.innerHTML = recentGamesData.map((game, index) => {
                    const timeAgo = formatTimestamp(game.timestamp);
                    const playerInitial = game.name.charAt(0).toUpperCase();
                    const position = index + 1;
                    
                    let positionClass = 'position-badge';
                    let positionIcon = 'fas fa-medal';
                    if (position === 1) {
                        positionClass += ' gold';
                        positionIcon = 'fas fa-crown';
                    } else if (position === 2) {
                        positionClass += ' silver';
                    } else if (position === 3) {
                        positionClass += ' bronze';
                    }
                    
                    return `
                        <div class="recent-game-item">
                            <div class="game-avatar">
                                <span>${playerInitial}</span>
                            </div>
                            <div class="game-info">
                                <div class="game-player">
                                    ${game.name}
                                    ${game.perfectGame ? '<i class="fas fa-star perfect-game"></i>' : ''}
                                </div>
                                <div class="game-details">
                                    <span class="game-score">
                                        <i class="fas fa-star"></i>
                                        ${game.score}
                                    </span>
                                    <span class="game-time">
                                        <i class="fas fa-clock"></i>
                                        ${timeAgo}
                                    </span>
                                </div>
                            </div>
                            <div class="game-position">
                                <div class="${positionClass}">
                                    <i class="${positionIcon}"></i>
                                    #${position}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading recent games:', error);
            }
        }

        // Enhanced timestamp formatting
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString('en-US', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        // Enhanced rank emoji
        function getRankEmoji(rank) {
            switch(rank) {
                case 1: return '🥇';
                case 2: return '🥈';
                case 3: return '🥉';
                default: return `#${rank}`;
            }
        }

        // Enhanced statistics calculation
        function updateStatistics(data) {
            const totalGames = data.length;
            const highestScore = data.length > 0 ? Math.max(...data.map(entry => entry.score)) : 0;
            const averageScore = data.length > 0 ? Math.round(data.reduce((sum, entry) => sum + entry.score, 0) / data.length) : 0;
            const uniquePlayers = new Set(data.map(entry => entry.name)).size;

            // Animate number changes
            animateNumber('total-games', totalGames);
            animateNumber('highest-score', highestScore);
            animateNumber('average-score', averageScore);
            animateNumber('active-players', uniquePlayers);
        }

        // Number animation function
        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            const increment = Math.ceil((targetValue - currentValue) / 20);
            
            if (currentValue !== targetValue) {
                element.textContent = Math.min(currentValue + increment, targetValue);
                setTimeout(() => animateNumber(elementId, targetValue), 50);
            }
        }

        // Enhanced leaderboard loading
        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                const tbody = document.getElementById('leaderboard-tbody');
                const emptyState = document.getElementById('empty-state');
                const errorState = document.getElementById('error-state');
                const tableContainer = document.querySelector('.table-container');
                
                errorState.style.display = 'none';
                
                if (data.length === 0) {
                    tableContainer.style.display = 'none';
                    emptyState.style.display = 'block';
                    updateStatistics([]);
                } else {
                    emptyState.style.display = 'none';
                    tableContainer.style.display = 'block';
                    
                    tbody.innerHTML = data.map((entry, index) => {
                        const rank = index + 1;
                        const rankDisplay = getRankEmoji(rank);
                        const timeDisplay = formatTimestamp(entry.timestamp);
                        const networkDisplay = entry.network || 'Unknown';
                        
                        const levelDisplay = entry.level || 'N/A';
                        const gameTimeDisplay = entry.gameTime ? `${(entry.gameTime / 1000).toFixed(1)}s` : 'N/A';
                        const perfectGameIcon = entry.perfectGame ? ' <i class="fas fa-crown perfect-game"></i>' : '';
                        const enhancedIcon = entry.stats?.gameVersion === 'improved_v1.0' ? ' <i class="fas fa-bolt enhanced-game"></i>' : '';
                        
                        return `
                            <tr class="leaderboard-row ${rank <= 3 ? 'top-rank' : ''}" data-rank="${rank}">
                                <td class="rank-cell">
                                    <div class="rank-display">${rankDisplay}</div>
                                </td>
                                <td class="name-cell">
                                    <div class="player-info">
                                        <span class="player-name">${entry.name}${perfectGameIcon}${enhancedIcon}</span>
                                        <div class="player-stats">
                                            <span><i class="fas fa-layer-group"></i> Level: ${levelDisplay}</span>
                                            <span><i class="fas fa-stopwatch"></i> Time: ${gameTimeDisplay}</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="score-cell">
                                    <div class="score-display">
                                        <span class="score-value">${entry.score}</span>
                                    </div>
                                </td>
                                <td class="time-cell">
                                    <span class="time-value">${timeDisplay}</span>
                                </td>
                                <td class="network-cell">
                                    <span class="network-value">
                                        <i class="fas fa-wifi"></i>
                                        ${networkDisplay}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    updateStatistics(data);
                }
                
                // Update server status
                document.getElementById('serverStatusDot').className = 'status-dot online';
                document.getElementById('serverStatusText').textContent = 'Online';
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                
                document.querySelector('.table-container').style.display = 'none';
                document.getElementById('empty-state').style.display = 'none';
                
                const errorState = document.getElementById('error-state');
                const errorMessage = document.getElementById('error-message');
                
                errorMessage.textContent = `Failed to load data: ${error.message}`;
                errorState.style.display = 'block';
                
                document.getElementById('serverStatusDot').className = 'status-dot offline';
                document.getElementById('serverStatusText').textContent = 'Offline';
            }
        }

        // Enhanced refresh timer
        function startRefreshTimer() {
            const timerElement = document.getElementById('refresh-timer');
            
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            nextRefreshTime = 10;
            
            refreshInterval = setInterval(() => {
                nextRefreshTime--;
                
                if (nextRefreshTime <= 0) {
                    loadLeaderboard();
                    loadRecentGames();
                    nextRefreshTime = 10;
                }
                
                timerElement.textContent = `Auto-refresh in ${nextRefreshTime}s`;
            }, 1000);
        }

        // Enhanced hardware status check
        async function checkHardwareStatus() {
            try {
                const response = await fetch('/api/game-status');
                const status = await response.json();
                
                document.getElementById('hardwareStatusDot').className = 'status-dot online';
                document.getElementById('hardwareStatusText').textContent = 'Connected';
                document.getElementById('esp8266-status').textContent = 'Online';
                document.getElementById('connection-status').textContent = 'Connected to Hardware';
                
            } catch (error) {
                document.getElementById('hardwareStatusDot').className = 'status-dot offline';
                document.getElementById('hardwareStatusText').textContent = 'Disconnected';
                document.getElementById('esp8266-status').textContent = 'Offline';
                document.getElementById('connection-status').textContent = 'Hardware Disconnected';
            }
        }

        // Enhanced initialization
        function init() {
            console.log('Simon Says IoT Enhanced Interface initialized');
            initializeAnimations();
            updateGameStatus('online', 'Ready to start a new game!');
            loadLeaderboard();
            loadRecentGames();
            checkHardwareStatus();
            startRefreshTimer();
            
            setInterval(checkHardwareStatus, 30000);
        }

        // Enhanced event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('playerName');
            
            // Enhanced input handling
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startGame();
                }
            });
            
            // Input animation
            nameInput.addEventListener('focus', () => {
                nameInput.parentElement.classList.add('focused');
            });
            
            nameInput.addEventListener('blur', () => {
                if (!nameInput.value) {
                    nameInput.parentElement.classList.remove('focused');
                }
            });
            
            // Initialize
            init();
        });

        // Enhanced visibility handling
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            } else {
                startRefreshTimer();
                loadLeaderboard();
                loadRecentGames();
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (gameCheckInterval) {
                clearInterval(gameCheckInterval);
            }
        });
    
        // Enhanced cleanup to prevent memory leaks
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            if (gameCheckInterval) {
                clearInterval(gameCheckInterval);
                gameCheckInterval = null;
            }
            console.log('✅ All intervals cleared - memory leak prevention');
        });

        // Page visibility cleanup
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Clear intervals when page is hidden
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
                if (gameCheckInterval) {
                    clearInterval(gameCheckInterval);
                }
            } else {
                // Restart intervals when page becomes visible
                startRefreshTimer();
                if (currentGame.isActive) {
                    startGameMonitoring();
                }
            }
        });
    
    </script>
    </body>
</html> 